{% extends 'base.html' %}
{% load static %}

{% block title %}AI 餐廳推薦{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">AI 餐廳推薦</h5>
                    <p class="card-text text-muted">輸入您的需求，讓 AI 為您推薦附近的餐廳。例如：</p>
                    <ul class="text-muted small">
                        <li>想吃辣的</li>
                        <li>便宜的日本料理</li>
                        <li>適合約會的餐廳</li>
                        <li>有素食選擇的餐廳</li>
                    </ul>
                    <div class="form-group">
                        <input type="text" class="form-control" id="searchQuery" placeholder="輸入您的需求">
                    </div>
                    <button class="btn btn-primary mt-3" id="searchButton" onclick="getRecommendation()">
                        <span class="normal-text">取得推薦</span>
                        <span class="loading-text d-none">
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            處理中...
                        </span>
                    </button>
                </div>
            </div>
            <div id="errorAlert" class="alert alert-danger mt-3 d-none" role="alert">
            </div>
            <div id="recommendationResults" class="mt-4">
                <!-- 推薦結果將在這裡顯示 -->
            </div>
        </div>
        <div class="col-md-8">
            <div id="map" style="height: 600px;"></div>
        </div>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>
<script>
let map;
let markers = [];

function initMap() {
    // 中央大學的座標
    const ncu = { lat: 24.9684, lng: 121.1955 };
    map = new google.maps.Map(document.getElementById('map'), {
        center: ncu,
        zoom: 15
    });
    
    // 添加中央大學的標記
    new google.maps.Marker({
        position: ncu,
        map: map,
        title: '國立中央大學',
        icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        }
    });
}

function setLoading(isLoading) {
    const button = document.getElementById('searchButton');
    const normalText = button.querySelector('.normal-text');
    const loadingText = button.querySelector('.loading-text');
    button.disabled = isLoading;
    
    if (isLoading) {
        normalText.classList.add('d-none');
        loadingText.classList.remove('d-none');
    } else {
        normalText.classList.remove('d-none');
        loadingText.classList.add('d-none');
    }
}

function showError(message) {
    const errorAlert = document.getElementById('errorAlert');
    errorAlert.textContent = message;
    errorAlert.classList.remove('d-none');
}

function hideError() {
    const errorAlert = document.getElementById('errorAlert');
    errorAlert.classList.add('d-none');
}

function getRecommendation() {
    const query = document.getElementById('searchQuery').value.trim();
    if (!query) {
        showError('請輸入搜尋內容');
        return;
    }

    hideError();
    setLoading(true);

    // 清除之前的標記
    markers.forEach(marker => marker.setMap(null));
    markers = [];
    
    // 清除之前的結果
    document.getElementById('recommendationResults').innerHTML = '';
    
    fetch('/ai_recommendation/get_recommendation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query: query })
    })
    .then(response => response.json())
    .then(data => {
        setLoading(false);
        if (data.success) {
            hideError();
            displayRecommendations(data.recommendations);
        } else {
            showError(data.error || '發生錯誤，請稍後再試');
        }
    })
    .catch(error => {
        setLoading(false);
        console.error('Error:', error);
        showError('發生網路錯誤，請稍後再試');
    });
}

function displayRecommendations(recommendations) {
    const resultsDiv = document.getElementById('recommendationResults');
    resultsDiv.innerHTML = '';
    
    if (recommendations.length === 0) {
        showError('找不到符合條件的餐廳');
        return;
    }
    
    const bounds = new google.maps.LatLngBounds();
    
    recommendations.forEach((rec, index) => {
        // 添加結果卡片
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
            <div class="card-body">
                <h5 class="card-title">
                    <span class="badge bg-primary me-2">${index + 1}</span>
                    ${rec.name}
                </h5>
                <h6 class="card-subtitle mb-2 text-muted">${rec.type}</h6>
                <p class="card-text">
                    <i class="fas fa-map-marker-alt text-danger me-2"></i>
                    ${rec.address}
                </p>
                <p class="card-text">
                    <i class="fas fa-lightbulb text-warning me-2"></i>
                    <small class="text-muted">${rec.analysis}</small>
                </p>
            </div>
        `;
        resultsDiv.appendChild(card);
        
        // 添加地圖標記
        const position = { lat: rec.lat, lng: rec.lng };
        const marker = new google.maps.Marker({
            position: position,
            map: map,
            title: rec.name,
            label: {
                text: (index + 1).toString(),
                color: 'white'
            },
            animation: google.maps.Animation.DROP
        });
        
        // 添加資訊視窗
        const infowindow = new google.maps.InfoWindow({
            content: `
                <div style="max-width: 200px;">
                    <h6 class="mb-1">${rec.name}</h6>
                    <p class="mb-1"><small>${rec.type}</small></p>
                    <p class="mb-0"><small>${rec.address}</small></p>
                </div>
            `
        });
        
        marker.addListener('click', () => {
            infowindow.open(map, marker);
        });
        
        markers.push(marker);
        bounds.extend(position);
    });
    
    // 調整地圖視角以顯示所有標記
    bounds.extend(new google.maps.LatLng(24.9684, 121.1955)); // 加入中央大學的位置
    map.fitBounds(bounds);
    
    // 如果縮放太近，設定最大縮放級別
    const listener = google.maps.event.addListener(map, 'idle', function() {
        if (map.getZoom() > 16) {
            map.setZoom(16);
        }
        google.maps.event.removeListener(listener);
    });
}

// 初始化地圖
window.onload = initMap;

// 添加按下 Enter 鍵搜尋的功能
document.getElementById('searchQuery').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        getRecommendation();
    }
});
</script>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.3s ease;
}
.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
</style>
{% endblock %} 